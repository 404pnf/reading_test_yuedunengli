<!DOCTYPE html>

<html>
<head>
  <title>textSelectionHighlight.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>textSelectionHighlight.js</h1>
        

        
      </div>

      
        
        <p>update: 2015-01-20</p>
<p>author: xiaobai</p>

        
      
        
        <h1 id="-">功能描述</h1>
<ol>
<li>用户选择id为yuedu的div中某些文字，会为选中的文字添加高亮样式。</li>
<li>用户点击已经高亮的文字，会取消高亮样式。</li>
</ol>

        
          <div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div>
        
      
        
        <h2 id="-">这个实现也是错误的。</h2>
<p>它比下面那个错误好一点的地方时用正则替换了所有匹配选中的部分。
比如  abc def abc hjk
如果选择了第二个abc，会高亮第一个和第二个abc，虽然也不好，
但至少用户不会觉得自己选中的没有高亮而是去高亮一个不相关的地方，</p>
<h2 id="-">改进选中部分。</h2>
<p>即使用户选择了一个字母，也扩展为字母所在的单词。
这个行为和kindle保持一致。
使用方法，正则：
捕获 零个或多个非空白且非’&gt;’字符 加鼠标选中的字符 加 零个或多个非空白且非’&lt;’或’&gt;’字符
中的鼠标选中字符。</p>

        
          <div class='highlight'><pre>    $(<span class="hljs-string">'#yuedu'</span>).mouseup(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">var</span> content, re, replacement, newHTML, oldHTML, target;

        { <span class="hljs-keyword">try</span>{</pre></div>
        
      
        
        <p>non-IE</p>

        
          <div class='highlight'><pre>            content = <span class="hljs-built_in">document</span>.getSelection().toString();
        } <span class="hljs-keyword">catch</span> (err) {</pre></div>
        
      
        
        <p>IE</p>

        
          <div class='highlight'><pre>            content = <span class="hljs-built_in">document</span>.selection.createRange().text;
            }
        }</pre></div>
        
      
        
        <ol>
<li>为了在正则中用变量，只能用regexp构造方法。</li>
<li>捕获content的括号分散在前后两个正则中，在js的正则使用变量只能这样。脏乱差啊。
ruby中很干净啦 Regexp.new(“ (#{a}) “)</li>
<li>content前面去匹配html的结束符号’&gt;’，后面是去匹配hmtl标签的开始符号’&lt;’。</li>
</ol>

        
          <div class='highlight'><pre>        re = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'([^ &gt;]*'</span> + content + <span class="hljs-string">'[^ &lt;]*)'</span>, <span class="hljs-string">"g"</span>);
        <span class="hljs-keyword">if</span> (content !== <span class="hljs-string">''</span>) {
            target = e.target;
            oldHTML = target.innerHTML;
            newHTML = oldHTML.replace(re, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(sel)</span> </span>{
                <span class="hljs-built_in">console</span>.log(sel);
                <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;span class='annotation'&gt;"</span> + sel + <span class="hljs-string">"&lt;/span&gt;"</span>
            });
            <span class="hljs-keyword">return</span> target.innerHTML = newHTML;
        }
    });</pre></div>
        
      
        
        <h2 id="-">我写了取消高亮的功能</h2>
<p>下面的实现是做不到的。
但取消功能依然让人迷惑。
因为它只取消你点击的高亮，而不是所有和点击高亮内容相同的高亮。
举例：还是上面的 abc def abc hjk
如果选择了第二个abc，会高亮第一个和第二个abc，虽然也不好，
但如果点击第二个abc触发取消高亮，第一个abc不会关联也取消的。
这是正确的方式。只是由于实现高亮用了错误的方式，才让这个取消功能也变得有点怪。</p>

        
      
        
        <p>取消高亮的时候，我们不但要取消css类，也应该取消span。否则遗留在页面的span会有时让
页面混乱。还好，有jquery帮忙。</p>

        
          <div class='highlight'><pre>    $(<span class="hljs-string">'#yuedu'</span>).delegate(<span class="hljs-string">"span"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">var</span> text = $(<span class="hljs-keyword">this</span>).text();
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'triggered!'</span>);
        $(<span class="hljs-keyword">this</span>).replaceWith(text);
    });</pre></div>
        
      
        
        <p>需要有这个事件监听。它会在用户试图选中已经高亮的区域时先取消掉高亮。
如果不这样做。用户再次选择已经高亮区域的部分文字，会出现嵌套的span。
在某些情况下让页面异常混乱。</p>

        
          <div class='highlight'><pre>    $(<span class="hljs-string">'#yuedu'</span>).delegate(<span class="hljs-string">"span"</span>, <span class="hljs-string">"mousedown"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> </span>{
        <span class="hljs-keyword">var</span> text = $(<span class="hljs-keyword">this</span>).text();
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'triggered!'</span>);
        $(<span class="hljs-keyword">this</span>).replaceWith(text);
    });
})();</pre></div>
        
      
        
        <h2 id="-">参考其他人的实现</h2>
<p><a href="http://zhidao.baidu.com/link?url=DukzamGwQXO308uHAqEWqr0kAvyVP6FBKc0uXNGE0kt_fRuBIIuiMpm8HkIDR0ChlYxBBNkCu22Fma3maKEDlEfq0n6RST7ziKioRLsBEGu">http://zhidao.baidu.com/link?url=DukzamGwQXO308uHAqEWqr0kAvyVP6FBKc0uXNGE0kt_fRuBIIuiMpm8HkIDR0ChlYxBBNkCu22Fma3maKEDlEfq0n6RST7ziKioRLsBEGu</a>
这个实现是错误的，简单的正则替换，会替换文章中第一次出现的选中词，而不是选中词。
比如  abc def abc hjk
如果选择了第二个abc，会高亮第一个abc，而第二个abc根本没变化。非常让人疑惑</p>
<p>而且这个例子的代码也真是脏乱差啊。</p>
<p>document.onmouseup=function(e){
    content=window.getSelection().toString();
    if(content!=’’){
        var len=content.length;
        var   target=e.target;
        var  position=target.innerHTML.indexOf(content);
        var  position2=position+len;
        var  tempstr1=target.innerHTML.substring(0,position);
        var tempstr2=target.innerHTML.substring(position2);
        content=”<span style='color:red;'>“+content+”</span>“;
        target.innerHTML=tempstr1+content+tempstr2;
    }}</p>

        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
